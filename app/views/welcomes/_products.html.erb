<div class="row">
  <% @products.each do |product| %>
    <div class="col-sm-6 col-md-4">
      <div class="thumbnail">
        <%= link_to image_tag(product.main_product_image.image.large.url, alt: product.title), product_path(product) %>
        <div class="caption">
          <h4><%= link_to product.title, product_path(product), class: 'title' %></h4>
          <p><strong>¥<%= product.price %></strong> <span class="msrp">¥<%= product.msrp %></span></p>
          <p><%= show_add_to_cart product, html_class: "btn-sm" %></p>
        </div>
      </div>
    </div>
  <% end -%>
</div>

<%= paginate @products %>

<%= content_for :javascripts do %>
  <script>
    $('.add-to-cart-btn').on('click', function() {
      var $this = $(this),
        $amount = $('input[name="amount"]'),
        $prog = $this.find('i');

      if ($amount.length > 0 && parseInt($amount.val()) <= 0) {
        alert("购买数量至少为 1");
        return false;
      }

      $.ajax({
        url: $this.attr('href'),
        method: 'post',
        data: { product_id: $this.data('product-id'), amount: $amount.val() },
        beforeSend: function() {
          if (!$prog.hasClass('fa-spin')) {
            $prog.addClass('fa-spin');
          }
          $prog.show();
        },
        success: function(data) {
          if ($('#shopping_cart_modal').length > 0) {
            $('#shopping_cart_modal').remove();
          }

          $('body').append(data);
          $('#shopping_cart_modal').modal();
        },
        complete: function() {
          $prog.hide();
        }
      })

      return false;
    })
  </script>
<% end %>
